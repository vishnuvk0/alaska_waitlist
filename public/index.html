<!DOCTYPE html>
<html>
<head>
  <title>Flight Waitlist Tracker</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px;
      line-height: 1.6;
    }
    .result { 
      margin-top: 1em; 
      padding: 1em; 
      border: 1px solid #ccc; 
      background: #fafafa; 
      white-space: pre-wrap;
      font-family: monospace;
      line-height: 1.4;
      border-radius: 5px;
    }
    input { 
      margin-bottom: 0.5em; 
      display: block;
      padding: 5px;
      width: 200px;
    }
    .segment { 
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .segment-header {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .changed { 
      color: #28a745; 
      font-weight: bold;
      padding-left: 5px;
    }
    .new-entry {
      background-color: #e8f5e9;
      padding: 2px 5px;
      border-radius: 3px;
      margin-left: 5px;
    }
    .refresh-button {
      margin-top: 1em;
      padding: 0.5em 1em;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    .refresh-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .timestamp {
      color: #666;
      font-size: 0.9em;
      font-style: italic;
      margin-top: 1em;
    }
    .route {
      margin: 10px 0;
      font-size: 1.1em;
    }
    .waitlist-info {
      margin: 15px 0;
    }
    .error {
      color: #dc3545;
      padding: 1em;
      border: 1px solid #dc3545;
      border-radius: 4px;
      margin: 1em 0;
    }
    .loading {
      color: #007bff;
      font-style: italic;
    }
    .waitlist-names {
      margin: 15px 0;
    }
    .separator {
      margin-top: 15px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Flight Waitlist Tracker</h1>
  <form id="trackerForm">
    <label>
      Flight Number:
      <input type="text" id="flightNumber" placeholder="e.g. 3411" required />
    </label>
    <label>
      Flight Date:
      <input type="date" id="flightDate" required />
    </label>
    <label>
      Your Name:
      <input type="text" id="userName" placeholder="LASTNAME/F" pattern="[A-Z]{2,3}/[A-Z]" 
             title="Format: LASTNAME/F (e.g., DOE/J)" />
    </label>
    <button type="submit" class="refresh-button">Check Waitlist</button>
  </form>

  <div class="result" id="resultArea"></div>
  <button id="refreshButton" class="refresh-button" style="display: none;">
    Check for Updates
  </button>

  <script>
    const form = document.getElementById('trackerForm');
    const resultArea = document.getElementById('resultArea');
    const refreshButton = document.getElementById('refreshButton');
    let lastQueryParams = null;

    function formatDateTime(dateStr) {
      if (!dateStr) return 'Not available';
      try {
        return new Date(dateStr).toLocaleString();
      } catch (e) {
        return dateStr;
      }
    }

    function formatSegment(segment, prevSegment = null, userName = '') {
      let html = `<div class="segment">`;
      
      // Header with flight info
      html += `<div class="segment-header">Flight AS${segment.flightNumber}</div>`;
      
      // Route and times
      html += `<div class="route">
        ${segment.origin} → ${segment.destination}<br>
        Departure: ${segment.departureTime}<br>
        Arrival: ${segment.arrivalTime}
      </div>`;
      
      // Waitlist information
      if (segment.waitlistInfo) {
        html += `<div class="waitlist-info">
          <strong>First Class Status:</strong><br>
          Total Capacity: ${segment.waitlistInfo.capacity}<br>
          Available Seats: ${segment.waitlistInfo.available}<br>
          Checked In: ${segment.waitlistInfo.checkedIn}
        </div>`;
        
        // Waitlist names
        if (segment.names && segment.names.length > 0) {
          html += `<div class="waitlist-names">
            <strong>Current Waitlist:</strong>
            <ol>`;
          segment.names.forEach(name => {
            const isUser = name === userName;
            html += `<li>${name}${isUser ? ' ← YOU' : ''}</li>`;
          });
          html += `</ol>
          </div>`;
        } else {
          html += '<div>No one on waitlist</div>';
        }
      }
      
      html += `<div class="separator">-------------------</div>`;
      html += '</div>';
      return html;
    }

    function displayWaitlist(data) {
      console.log('Displaying data:', data);
      
      if (!data.segments || data.segments.length === 0) {
        resultArea.innerHTML = '<div class="error">No flight segments found.</div>';
        return;
      }
      
      let html = 'Waitlist Results\n\n';
      
      data.segments.forEach((segment, index) => {
        html += `=== Flight AS${segment.flightNumber} Segment ${index + 1} ===\n`;
        html += `${segment.origin}->${segment.destination}\n`;
        
        if (segment.waitlistInfo) {
          html += `Capacity: ${segment.waitlistInfo.capacity}\n`;
          html += `Available: ${segment.waitlistInfo.available}\n`;
          html += `Checked In: ${segment.waitlistInfo.checkedIn}\n\n`;
          
          if (segment.names && segment.names.length > 0) {
            html += 'Current Waitlist:\n';
            segment.names.forEach((name, i) => {
              const isUser = name === document.getElementById('userName').value.trim();
              html += `${i + 1}. ${name}${isUser ? ' ← YOU' : ''}\n`;
            });
          } else {
            html += 'No one on waitlist\n';
          }
        }
        
        html += '\n-------------------\n\n';
      });
      
      resultArea.textContent = html;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultArea.textContent = 'Checking waitlist...';
      refreshButton.style.display = 'none';

      const params = {
        flightNumber: document.getElementById('flightNumber').value.trim(),
        flightDate: document.getElementById('flightDate').value.trim(),
        userName: document.getElementById('userName').value.trim()
      };

      try {
        // Just use the main trackWaitlist endpoint
        const response = await fetch('/api/trackWaitlist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        
        const data = await response.json();
        console.log('Received data:', data); // Debug log

        if (data.error) {
          resultArea.innerHTML = `<div class="error">${data.error}</div>`;
          return;
        }

        displayWaitlist(data);
        lastQueryParams = params;
        refreshButton.style.display = 'block';

      } catch (err) {
        console.error(err);
        resultArea.innerHTML = '<div class="error">An error occurred while fetching the waitlist.</div>';
      }
    });

    refreshButton.addEventListener('click', async () => {
      if (!lastQueryParams) return;
      
      refreshButton.disabled = true;
      refreshButton.textContent = 'Checking...';
      resultArea.innerHTML = '<div class="loading">Refreshing waitlist data...</div>';

      try {
        const response = await fetch('/api/trackWaitlist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(lastQueryParams)
        });
        
        const data = await response.json();
        console.log('Received refresh data:', data); // Debug log

        if (data.error) {
          resultArea.innerHTML = `<div class="error">${data.error}</div>`;
          return;
        }

        displayWaitlist(data);

      } catch (err) {
        console.error(err);
        resultArea.innerHTML = '<div class="error">Error while refreshing data.</div>';
      } finally {
        refreshButton.disabled = false;
        refreshButton.textContent = 'Check for Updates';
      }
    });
  </script>
</body>
</html>

